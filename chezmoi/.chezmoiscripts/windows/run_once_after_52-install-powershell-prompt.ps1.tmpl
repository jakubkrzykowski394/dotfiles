{{- if eq .chezmoi.os "windows" -}}
# https://ohmyposh.dev/docs/faq
# https://learn.microsoft.com/en-us/windows/terminal/tutorials/custom-prompt-setup

# Install the Meslo nerd font
# TODO: check if fonts are already installed
oh-my-posh font install meslo

# Set the theme
$initLine = 'oh-my-posh init pwsh --config "$env:POSH_THEMES_PATH/powerlevel10k_rainbow.omp.json" | Invoke-Expression'
$initPrefix = 'oh-my-posh init'

# Define profile paths for Windows PowerShell and PowerShell Core
# TODO: this throws an error about outdated powershell version
$profiles = @($PROFILE, "$HOME\Documents\PowerShell\Microsoft.PowerShell_profile.ps1")

foreach ($profile in $profiles) {
    # Read the profile file content
    if (Test-Path -Path $profile) {
        $profileContent = Get-Content -Path $profile -Raw
    } else {
        $profileContent = ""
    }

    # Check if any line starts with "oh-my-posh init"
    if ($profileContent -match "^$initPrefix.*") {
        # Replace the existing line with the new initLine
        $profileContent = $profileContent -replace "^$initPrefix.*", $initLine
        Set-Content -Path $profile -Value $profileContent
    } else {
        # Append the init line to the profile file if it doesn't already exist
        Add-Content -Path $profile -Value $initLine
    }
}

# Reload the profile
. $PROFILE

{{ end -}}
